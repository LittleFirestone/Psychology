<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Healing Journey Diary</title>
  <style>
    :root{
      --bg1:#fde1e7; --bg2:#e7f6ff; --bg3:#eaf8f2; --bg4:#f7ecff;
      --ink:#2f3a4b; --ink-soft:#566074;
      --panel: rgba(255,255,255,.86); /* softer than pure white */
      --ring: 0 0 0 3px rgba(255,255,255,.55), 0 10px 30px rgba(43,45,66,.08);

      --rp0:#ffadd6; --rp1:#ffc7a8; --rp2:#ffe8a6; --rp3:#bff4c6;
      --rp4:#a9ecff; --rp5:#c8c7ff; --rp6:#f6bfff;

      --chipA: .28;
    }

    /* Animated pastel background */
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); font:16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(115deg,var(--bg1),var(--bg2),var(--bg3),var(--bg4));
      background-size: 220% 220%;
      animation: floatBg 18s ease-in-out infinite;
    }
    @keyframes floatBg{ 0%{background-position:0 0} 50%{background-position:100% 100%} 100%{background-position:0 0} }

    .wrap{ max-width: 1100px; margin: 36px auto 80px; padding: 0 18px; }

    /* Card panels */
    .card{
      background: var(--panel);
      border-radius: 22px;
      box-shadow: var(--ring);
      padding: 20px;
      backdrop-filter: blur(6px);
      margin-bottom: 22px;      /* give every section air so nothing overlaps */
      position: relative;       /* prevent weird stacking */
    }

    /* Rainbow headline */
    .title{
      font-size: clamp(28px,3vw,40px);
      font-weight: 800;
      letter-spacing:.3px;
      margin: 0 0 18px;
      line-height:1.1;
      background: linear-gradient(90deg,
        var(--rp0),var(--rp1),var(--rp2),var(--rp3),var(--rp4),var(--rp5),var(--rp6));
      background-size: 200% auto;
      -webkit-background-clip: text; background-clip: text; color: transparent;
      animation: sweep 8s linear infinite;
    }
    @keyframes sweep{ 0%{background-position:0% 50%} 100%{background-position:200% 50%} }

    /* Layout */
    .grid{ display:grid; gap:14px; grid-template-columns: repeat(12,1fr); align-items:start; }
    .col-12{ grid-column: span 12; } .col-6{ grid-column: span 6; } .col-4{ grid-column: span 4; }
    @media (max-width:900px){ .col-6,.col-4{ grid-column: span 12; } }

    label{ font-size:13px; font-weight:700; color:var(--ink-soft); display:block; margin: 6px 0 6px; }
    input[type="text"], textarea, select{
      width:100%; border:1px solid #e7e9ee; background:#fff; color:var(--ink);
      border-radius: 14px; padding: 12px 14px; outline:none;
      box-shadow: inset 0 1px 0 rgba(0,0,0,.02);
    }
    textarea{ resize: vertical; min-height: 120px; }

    .btn{
      border:0; padding: 12px 16px; border-radius: 14px; font-weight: 700; cursor: pointer;
      transition: transform .05s ease, filter .2s ease;
      background:#eff2f8;
    }
    .btn:active{ transform: translateY(1px) }

    .btn-rainbow{
      color:#26303f; background: linear-gradient(90deg,
        color-mix(in oklab, var(--rp0) 65%, white 35%),
        color-mix(in oklab, var(--rp2) 65%, white 35%),
        color-mix(in oklab, var(--rp4) 65%, white 35%),
        color-mix(in oklab, var(--rp6) 65%, white 35%)
      );
      box-shadow: 0 8px 20px rgba(180,170,255,.25);
    }

    .toolbar{ display:flex; gap:10px; flex-wrap: wrap; align-items:center }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px; font-weight:700; font-size:12px;
      background: linear-gradient(135deg,
        rgba(255,173,214,var(--chipA)),
        rgba(255,232,166,var(--chipA)));
      border: 1px solid rgba(255,173,214,.5);
      box-shadow: 0 3px 10px rgba(0,0,0,.06);
    }
    .chip .x{ cursor:pointer; font-weight:900; padding:0 4px; opacity:.65 }
    .chip .x:hover{ opacity:1 }
    .chip[data-hue="0"]{ background: linear-gradient(135deg, rgba(255,173,214,.28), rgba(255,231,166,.28)); border-color: rgba(255,173,214,.5); }
    .chip[data-hue="1"]{ background: linear-gradient(135deg, rgba(255,199,168,.28), rgba(191,244,198,.28)); border-color: rgba(255,199,168,.5); }
    .chip[data-hue="2"]{ background: linear-gradient(135deg, rgba(255,232,166,.28), rgba(169,236,255,.28)); border-color: rgba(255,232,166,.5); }
    .chip[data-hue="3"]{ background: linear-gradient(135deg, rgba(191,244,198,.28), rgba(200,199,255,.28)); border-color: rgba(191,244,198,.5); }
    .chip[data-hue="4"]{ background: linear-gradient(135deg, rgba(169,236,255,.28), rgba(246,191,255,.28)); border-color: rgba(169,236,255,.5); }

    .section-title{
      font-weight:900; margin: 4px 0 10px;
      background: linear-gradient(90deg,var(--rp1),var(--rp3),var(--rp5));
      -webkit-background-clip: text; background-clip:text; color:transparent;
    }

    .entry{
      border:1px solid #eef0f6; border-radius:18px; padding:14px 14px 12px;
      background: #fff; box-shadow: 0 6px 16px rgba(20,24,40,.05);
    }
    .entry h4{ margin: 0 0 8px; font-size:16px }
    .entry .meta{ font-size:12px; color:#6a7280; margin-bottom:8px }
    .entry .tags{ display:flex; gap:8px; flex-wrap: wrap; margin-top:8px }

    .list{ display:grid; gap:12px; }
    .muted{ color:#718096 }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap: wrap; }

    .box-title{
      font-weight:800; font-size: 18px; margin:0 0 8px;
      background: linear-gradient(90deg,var(--rp0),var(--rp2),var(--rp4),var(--rp6));
      -webkit-background-clip: text; background-clip:text; color:transparent;
    }
  </style>

  <!-- html2canvas + jsPDF for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
</head>
<body>
  <div class="wrap">
    <header class="card">
      <h1 class="title">Healing Journey Diary</h1>
      <div class="row">
        <button class="btn btn-rainbow" id="addBtn">Add Entry</button>
        <button class="btn" id="exportBtn" title="Export visible entries as PDF">Export as PDF</button>
      </div>
    </header>

    <!-- Add Entry -->
    <section class="card">
      <h3 class="box-title">New Entry</h3>
      <div class="grid">
        <div class="col-6">
          <label for="topic">Topic</label>
          <input id="topic" type="text" placeholder="e.g. Anxiety, Gratitude, Wins" />
        </div>
        <div class="col-6">
          <label for="mood">Mood</label>
          <select id="mood">
            <option value="üòä Joyful">üòä Joyful</option>
            <option value="üôÇ Calm">üôÇ Calm</option>
            <option value="üòê Neutral">üòê Neutral</option>
            <option value="üòï Uneasy">üòï Uneasy</option>
            <option value="üòû Low">üòû Low</option>
          </select>
        </div>
        <div class="col-12">
          <label for="text">Entry</label>
          <textarea id="text" placeholder="Write freely. You can add tags below‚Ä¶"></textarea>
        </div>
        <div class="col-12">
          <label for="tagsInput">Tags (comma or Enter)</label>
          <input id="tagsInput" type="text" placeholder="e.g. breathing, therapy, progress" />
          <div class="toolbar" id="tagsBar" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- Filters / Search -->
    <section class="card">
      <h3 class="box-title">Search & Filter</h3>
      <div class="grid">
        <div class="col-4">
          <label for="search">Search text</label>
          <input id="search" type="text" placeholder="Find words in entries‚Ä¶" />
        </div>
        <div class="col-4">
          <label for="filterTopic">Filter by topic</label>
          <input id="filterTopic" type="text" placeholder="Type a topic name‚Ä¶" />
        </div>
        <div class="col-4">
          <label for="filterTag">Filter by tag</label>
          <input id="filterTag" type="text" placeholder="Type a tag‚Ä¶" />
        </div>
      </div>
    </section>

    <!-- Summaries -->
    <section class="card">
      <h3 class="box-title">Summarize Topics</h3>
      <div class="grid">
        <div class="col-12">
          <label for="topicsMultiInput">Topics to summarize (comma separated, or type <all>)</label>
          <input id="topicsMultiInput" type="text" placeholder="e.g. Anxiety, Gratitude" />
        </div>
        <div class="col-12">
          <div class="row">
            <button class="btn btn-rainbow" id="summarizeBtn">Summarize (Newsletter Style)</button>
            <small class="muted">If API isn‚Äôt configured, it will use a built-in summarizer.</small>
          </div>
        </div>
        <div class="col-12">
          <div id="summaryOut" class="entry" style="display:none"></div>
        </div>
      </div>
    </section>

    <!-- Entries list -->
    <section class="card" id="entriesCard">
      <h3 class="box-title">Entries</h3>
      <div id="entries" class="list"></div>
      <p id="empty" class="muted" style="margin-top:8px; display:none;">No entries found.</p>
    </section>
  </div>

  <script>
    // Simple storage helpers
    const load = (k, d) => JSON.parse(localStorage.getItem(k) || JSON.stringify(d));
    const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

    let entries = load('hj_entries', []);
    let draftTags = [];

    const $ = (id) => document.getElementById(id);
    const els = {
      addBtn: $('addBtn'), exportBtn: $('exportBtn'),
      topic: $('topic'), mood: $('mood'), text: $('text'),
      tagsInput: $('tagsInput'), tagsBar: $('tagsBar'),
      search: $('search'), filterTopic: $('filterTopic'), filterTag: $('filterTag'),
      entries: $('entries'), empty: $('empty'),
      topicsMultiInput: $('topicsMultiInput'), summarizeBtn: $('summarizeBtn'), summaryOut: $('summaryOut'),
      entriesCard: $('entriesCard'),
    };

    // ------- TAGS -------
    const renderDraftTags = () => {
      els.tagsBar.innerHTML = '';
      draftTags.forEach((t, i) => {
        const chip = document.createElement('span');
        chip.className = 'chip'; chip.dataset.hue = i % 5;
        chip.innerHTML = `<span>#${escapeHtml(t)}</span><span class="x" title="Remove tag" data-i="${i}">‚úï</span>`;
        els.tagsBar.appendChild(chip);
      });
    };

    const addDraftTagsFromInput = () => {
      const raw = els.tagsInput.value.trim();
      if (!raw) return;
      raw.split(',').map(s => s.trim()).filter(Boolean).forEach(v=>{
        if (!draftTags.includes(v.toLowerCase())) draftTags.push(v.toLowerCase());
      });
      els.tagsInput.value = '';
      renderDraftTags();
    };

    els.tagsInput.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' || e.key === ','){ e.preventDefault(); addDraftTagsFromInput(); }
      if (e.key === 'Backspace' && !els.tagsInput.value && draftTags.length){ draftTags.pop(); renderDraftTags(); }
    });
    els.tagsBar.addEventListener('click', (e)=>{
      const i = e.target.dataset.i;
      if (i !== undefined){ draftTags.splice(Number(i),1); renderDraftTags(); }
    });

    // ------- ADD ENTRY -------
    els.addBtn.addEventListener('click', ()=>{
      const topic = els.topic.value.trim() || 'General';
      const mood = els.mood.value;
      const text = els.text.value.trim();
      if (!text){ alert('Please write something in the entry.'); return; }
      const now = new Date().toISOString();
      const tags = [...draftTags];
      entries.unshift({ id: crypto.randomUUID(), topic, mood, text, tags, createdAt: now });
      save('hj_entries', entries);
      // clear
      els.text.value = ''; els.topic.value = ''; draftTags = []; renderDraftTags();
      refresh();
    });

    // ------- RENDER LIST -------
    function refresh(){
      // filters
      const q = els.search.value.trim().toLowerCase();
      const fTopic = els.filterTopic.value.trim().toLowerCase();
      const fTag = els.filterTag.value.trim().toLowerCase();

      const filtered = entries.filter(e=>{
        const textHit = !q || (e.text.toLowerCase().includes(q) || e.topic.toLowerCase().includes(q) || e.tags.some(t=>t.includes(q)));
        const topicHit = !fTopic || e.topic.toLowerCase().includes(fTopic);
        const tagHit = !fTag || e.tags.some(t => t.includes(fTag));
        return textHit && topicHit && tagHit;
      });

      els.entries.innerHTML = filtered.map((e,i)=>renderEntry(e,i)).join('');
      els.empty.style.display = filtered.length ? 'none' : 'block';
    }

    function renderEntry(e, index){
      const date = new Date(e.createdAt).toLocaleString();
      const tagHtml = e.tags.map((t,i)=>`<span class="chip" data-hue="${i%5}">#${escapeHtml(t)}</span>`).join(' ');
      return `
        <article class="entry">
          <h4 class="section-title" style="margin:0">
            <span style="background:linear-gradient(90deg,var(--rp${index%7}),var(--rp${(index+2)%7}),var(--rp${(index+4)%7}));
                         -webkit-background-clip:text;background-clip:text;color:transparent;">
              ${escapeHtml(e.topic)}
            </span>
          </h4>
          <div class="meta">${escapeHtml(e.mood)} ¬∑ ${date}</div>
          <div>${nl2br(escapeHtml(e.text))}</div>
          <div class="tags">${tagHtml}</div>
        </article>
      `;
    }

    ['search','filterTopic','filterTag'].forEach(id=>$(id).addEventListener('input', refresh));

    // ------- SUMMARY (GPT first, fallback to local ‚Äúnewsletter‚Äù style) -------
    els.summarizeBtn.addEventListener('click', async ()=>{
      const raw = els.topicsMultiInput.value.trim();
      if (!raw){ alert('Type one or more topics (comma separated), or <all>.'); return; }
      let chosen = raw.toLowerCase() === 'all'
        ? [...new Set(entries.map(e=>e.topic))]
        : raw.split(',').map(s=>s.trim()).filter(Boolean);

      const group = entries.filter(e=> chosen.includes(e.topic));
      if (!group.length){ alert('No entries for those topics.'); return; }

      // Try calling Vercel API
      let summary;
      try{
        const res = await fetch('/api/summarize', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ topics: chosen, entries: group }),
        });
        if(!res.ok) throw new Error('API error');
        const data = await res.json();
        summary = data.summary;
      }catch(err){
        // Fallback ‚Äî local newsletter-style summarizer
        summary = newsletterFallback(group);
      }

      els.summaryOut.style.display = 'block';
      els.summaryOut.innerHTML = `
        <div class="section-title" style="margin-bottom:6px">Newsletter Summary (${escapeHtml(chosen.join(', '))})</div>
        <div>${nl2br(escapeHtml(summary))}</div>
      `;
    });

    function newsletterFallback(group){
      // Merge all text
      const texts = group.map(e=>e.text).join('\n');
      const tags = group.flatMap(e=>e.tags);
      const moods = group.map(e=>e.mood);
      const moodCount = Object.fromEntries([...new Set(moods)].map(m=>[m, moods.filter(x=>x===m).length]));
      const topTags = Object.entries(tags.reduce((a,t)=> (a[t]=(a[t]||0)+1, a), {}))
        .sort((a,b)=>b[1]-a[1]).slice(0,5).map(([t,c])=>`#${t} (${c})`);

      const sentences = texts.split(/(?<=[.!?])\s+/).filter(Boolean);
      const pulls = sentences.filter(s=>s.length<140).slice(0,3);

      // Simple key points extract (freq-based)
      const points = keyPoints(texts, 5);

      return [
        `Subject ideas:`,
        `‚Ä¢ Weekly Healing Highlights`,
        `‚Ä¢ Progress & Patterns Roundup`,
        ``,
        `Intro (2 sentences):`,
        wrap(`This week‚Äôs entries highlight recurring themes across your focus topics. Here‚Äôs a quick brief you can paste into a newsletter and share (or keep for yourself).`),
        ``,
        `Key wins & bright spots:`,
        ...points.wins.map(p=>'‚Ä¢ '+p),
        ``,
        `Challenges & friction:`,
        ...points.challenges.map(p=>'‚Ä¢ '+p),
        ``,
        `Suggested next actions (small & specific):`,
        ...points.actions.map(p=>'‚Ä¢ '+p),
        ``,
        `Mood trend snapshot: ${Object.entries(moodCount).map(([m,c])=>`${m}√ó${c}`).join(' ¬∑ ') || '‚Äî'}`,
        `Top tags: ${topTags.join(' ¬∑ ') || '‚Äî'}`,
        ``,
        `Notable lines you could quote:`,
        ...pulls.map(p=>'‚Äú'+p.replace(/\n/g,' ')+'‚Äù'),
      ].join('\n');
    }

    function keyPoints(text, n=5){
      const sents = text.split(/(?<=[.!?])\s+/).filter(Boolean);
      const words = text.toLowerCase().match(/[a-z‚Äô']+/g) || [];
      const stop = new Set('i me my myself we our you your yours he she it they them a an the and or but if then so to of in on for with from at by as is are was were be been being feel feels felt feeling today this that those these not very really just have has had do did doing will would can could should may might'.split(' '));
      const freq = new Map();
      for (const w of words){ if (!stop.has(w) && w.length>2) freq.set(w, (freq.get(w)||0)+1); }
      const score = s => (s.toLowerCase().match(/[a-z‚Äô']+/g)||[]).reduce((acc,w)=>acc+(freq.get(w)||0),0);
      const ranked = sents.map(s=>({s,score:score(s)})).sort((a,b)=>b.score-a.score).slice(0, n*2).map(o=>o.s);

      const bucket = (arr,label)=>arr.filter((_,i)=>i%3===label).slice(0,n);
      return {
        wins: bucket(ranked,0),
        challenges: bucket(ranked,1),
        actions: bucket(ranked,2).map(s=>s.replace(/^/,'Try: ')),
      };
    }

    // ------- PDF EXPORT -------
    $('exportBtn').addEventListener('click', async ()=>{
      await exportElementToPDF(els.entriesCard, 'Healing-Diary.pdf');
    });

    async function exportElementToPDF(node, filename){
      const { jsPDF } = window.jspdf;
      const canvas = await html2canvas(node, { scale: 2, backgroundColor: '#ffffff' });
      const img = canvas.toDataURL('image/png');
      const pdf = new jsPDF('p','pt','a4');
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const ratio = Math.min(pageW / canvas.width, pageH / canvas.height);
      const w = canvas.width * ratio, h = canvas.height * ratio;
      pdf.addImage(img, 'PNG', (pageW - w)/2, 24, w, h);
      pdf.save(filename);
    }

    // ------- UTIL -------
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function nl2br(s){ return s.replace(/\n/g,'<br>'); }

    // ------- INIT -------
    function init(){ renderDraftTags(); refresh(); }
    init();
  </script>
</body>
</html>
