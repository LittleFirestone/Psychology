<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Healing Diary</title>

  <!-- Pastel look & roomy layout -->
  <style>
    :root{
      --ink:#1f2937;
      --muted:#6b7280;
      --ring:#e5e7eb;
      --accent:#7c8cff;
      --accent-ink:#ffffff;
      --chip:#ffe8e3;
      --bg-grad: linear-gradient(135deg,#f8f4ff 0%,#fff6f6 40%,#f6fffb 100%);
      --card-bg: rgba(255,255,255,.88);
      --card-shadow: 0 14px 40px rgba(0,0,0,.08);
      --radius: 16px;
      --wrap-max: 1200px;
      --space: 20px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--ink);
      background:var(--bg-grad) fixed;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      font-size:18px; /* nice and readable */
      line-height:1.4;
    }
    .wrap{
      max-width:var(--wrap-max);
      margin:32px auto;
      padding:clamp(16px,3vw,28px);
      background:var(--card-bg);
      border-radius:var(--radius);
      box-shadow:var(--card-shadow);
      backdrop-filter: blur(8px);
    }
    h1{
      margin:0 0 8px;
      font-size:clamp(28px,3.4vw,40px);
      letter-spacing:.2px;
    }
    .sub{
      margin:0 0 18px;
      color:var(--muted);
      font-size:15px;
    }

    /* controls */
    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin: 8px 0 22px;
    }
    button, input, select, textarea{
      font:inherit;
      border-radius:12px;
      border:1px solid var(--ring);
      padding:12px 14px;
      background:#fff;
      color:var(--ink);
    }
    button{
      cursor:pointer;
      transition:transform .02s ease, box-shadow .2s ease;
    }
    button:hover{ box-shadow:0 6px 16px rgba(0,0,0,.08) }
    button:active{ transform:translateY(1px) }
    .primary{ background:var(--accent); color:var(--accent-ink); border:0 }
    .ghost{ background:transparent }
    .chip{
      background:var(--chip);
      border:0;
      padding:8px 10px;
      border-radius:999px;
      font-size:14px;
    }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    .row-3{ display:grid; grid-template-columns: 2fr 3fr 2fr; gap:14px; }
    .row-1{ display:grid; grid-template-columns: 1fr; gap:14px; }
    label{ font-weight:600; font-size:14px; color:#374151 }
    .field{ display:flex; flex-direction:column; gap:8px }
    textarea{ min-height:140px; resize:vertical }
    .divider{ height:1px; background:var(--ring); margin:18px 0 }

    /* list */
    .list{ display:grid; gap:12px; margin-top:10px }
    .card{
      background:#fff;
      border:1px solid var(--ring);
      border-radius:14px;
      padding:14px;
      display:grid;
      gap:8px;
    }
    .card h3{ margin:0; font-size:18px }
    .meta{ color:var(--muted); font-size:14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .tags{ display:flex; gap:6px; flex-wrap:wrap }
    .tag{ background:#eef2ff; color:#3843a7; padding:4px 8px; border-radius:999px; font-size:12px }

    /* summary output */
    .summary{
      white-space:pre-wrap;
      background:#fff;
      border:1px dashed var(--ring);
      padding:14px;
      border-radius:14px;
      margin-top:8px;
    }

    /* responsive */
    @media (max-width: 860px){
      .row, .row-3{ grid-template-columns: 1fr }
    }
  </style>

  <!-- PDF export (html2pdf bundles html2canvas + jsPDF) -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
</head>
<body>
  <div class="wrap" id="wrap">
    <header>
      <h1>Healing Diary</h1>
      <p class="sub">Your private space for sessions, insights, and progress. Everything saves locally in this browser.</p>
      <div class="toolbar">
        <button class="primary" id="saveBtn">Save Entry</button>
        <button id="clearFormBtn">Clear Form</button>
        <button class="ghost" id="exportBtn">Export PDF</button>
        <button class="ghost" id="deleteAllBtn" title="Remove all saved entries">Delete All</button>
      </div>
    </header>

    <!-- Entry form -->
    <section class="card">
      <div class="row-3">
        <div class="field">
          <label>Date</label>
          <input type="date" id="date">
        </div>
        <div class="field">
          <label>Topic (e.g. “Therapy Session”, “Mood”, “Insight”)</label>
          <input id="topic" placeholder="Pick a topic name">
        </div>
        <div class="field">
          <label>Tags (comma separated)</label>
          <input id="tags" placeholder="e.g. anxiety, CBT, progress">
        </div>
      </div>

      <div class="row-1">
        <div class="field">
          <label>Title</label>
          <input id="title" placeholder="Give this a punchy title">
        </div>
      </div>

      <div class="row-1">
        <div class="field">
          <label>Notes</label>
          <textarea id="text" placeholder="What happened, what you felt, what meaning you made…"></textarea>
        </div>
      </div>
    </section>

    <div class="divider"></div>

    <!-- Filters & actions -->
    <section class="card">
      <div class="row">
        <div class="field">
          <label>Search text</label>
          <input id="search" placeholder="Search across all entries…">
        </div>
        <div class="field">
          <label>Filter by topic</label>
          <select id="topicFilter"><option value="">All topics</option></select>
        </div>
      </div>

      <div class="toolbar" style="margin-top:12px">
        <button id="summarizeBtn">Summarize selected topics</button>
        <span class="chip" id="countChip">0 selected</span>
      </div>

      <div id="summary" class="summary" style="display:none"></div>
    </section>

    <!-- Entries -->
    <section>
      <div class="list" id="list"></div>
    </section>
  </div>

  <script>
    /********************
     * Local storage
     ********************/
    const storeKey = 'healing-diary-v2';
    const load = () => JSON.parse(localStorage.getItem(storeKey) || '[]');
    const save = (arr) => localStorage.setItem(storeKey, JSON.stringify(arr));

    /********************
     * Elements
     ********************/
    const el = id => document.getElementById(id);
    const dateEl = el('date');
    const topicEl = el('topic');
    const tagsEl = el('tags');
    const titleEl = el('title');
    const textEl = el('text');

    const listEl = el('list');
    const topicFilterEl = el('topicFilter');
    const searchEl = el('search');
    const countChip = el('countChip');
    const summaryBox = el('summary');

    const saveBtn = el('saveBtn');
    const clearFormBtn = el('clearFormBtn');
    const exportBtn = el('exportBtn');
    const deleteAllBtn = el('deleteAllBtn');
    const summarizeBtn = el('summarizeBtn');

    /********************
     * Init
     ********************/
    // default date today
    dateEl.valueAsDate = new Date();

    let entries = load();
    let selectedTopics = new Set();

    renderAll();

    /********************
     * UI actions
     ********************/
    saveBtn.addEventListener('click', () => {
      const entry = {
        id: crypto.randomUUID(),
        date: dateEl.value || new Date().toISOString().slice(0,10),
        topic: (topicEl.value || '').trim(),
        tags: (tagsEl.value || '')
          .split(',')
          .map(t => t.trim())
          .filter(Boolean),
        title: (titleEl.value || '').trim(),
        text: (textEl.value || '').trim()
      };

      if(!entry.text){
        alert('Please write some notes before saving.');
        return;
      }
      entries.unshift(entry);
      save(entries);
      clearForm();
      renderAll();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    clearFormBtn.addEventListener('click', clearForm);
    deleteAllBtn.addEventListener('click', () => {
      if(confirm('Delete ALL entries? This cannot be undone.')){
        entries = [];
        save(entries);
        renderAll();
      }
    });

    exportBtn.addEventListener('click', () => {
      const opt = {
        margin:       8,
        filename:     `Healing-Diary-${new Date().toISOString().slice(0,10)}.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(document.getElementById('wrap')).save();
    });

    topicFilterEl.addEventListener('change', renderList);
    searchEl.addEventListener('input', renderList);

    summarizeBtn.addEventListener('click', async () => {
      if(selectedTopics.size === 0){
        alert('Select at least one topic checkbox below, then click Summarize.');
        return;
      }
      summaryBox.style.display = 'block';
      summaryBox.textContent = 'Summarizing…';

      // Gather text by selected topics
      const grouped = {};
      for(const t of selectedTopics) grouped[t] = [];
      for(const e of entries){
        if(selectedTopics.has(e.topic || 'Untitled')) grouped[e.topic || 'Untitled'].push(e.text);
      }

      const prompt = buildSummaryPrompt(grouped);

      // 1) try your future serverless endpoint at /api/summarize
      //    (safe place to call OpenAI with your API key)
      try{
        const controller = new AbortController();
        const t = setTimeout(()=>controller.abort(), 12000); // 12s safety
        const res = await fetch('/api/summarize', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ prompt }),
          signal: controller.signal
        });
        clearTimeout(t);
        if(res.ok){
          const data = await res.json();
          if(data && data.summary){
            summaryBox.textContent = data.summary.trim();
            return;
          }
        }
      }catch(err){
        // ignore and fall back
      }

      // 2) fallback: on-device extractive summary
      const fallback = localSummarize(grouped, 6);
      summaryBox.textContent = fallback;
    });

    /********************
     * Renderers
     ********************/
    function renderAll(){
      renderTopicsFilter();
      renderList();
    }

    function renderTopicsFilter(){
      const topics = Array.from(new Set(entries.map(e => (e.topic || 'Untitled').trim()))).sort();
      topicFilterEl.innerHTML = `<option value="">All topics</option>` + 
        topics.map(t=>`<option>${escapeHTML(t || 'Untitled')}</option>`).join('');
    }

    function renderList(){
      const q = (searchEl.value || '').toLowerCase();
      const onlyTopic = (topicFilterEl.value || '').trim();

      // prepare checkboxes per topic
      const topics = Array.from(new Set(entries.map(e => (e.topic || 'Untitled').trim()))).sort();

      // topic selector row
      const topicRow = `
        <div class="card">
          <div class="meta"><strong>Select topics to summarize:</strong></div>
          <div class="tags" id="topicChecks">
            ${topics.map(t=>{
              const id = 't_' + t.replace(/\W+/g,'_');
              const checked = selectedTopics.has(t) ? 'checked' : '';
              return `
                <label class="chip" style="display:inline-flex;gap:8px;align-items:center;">
                  <input type="checkbox" id="${id}" data-topic="${escapeAttr(t)}" ${checked}>
                  ${escapeHTML(t || 'Untitled')}
                </label>
              `;
            }).join('')}
          </div>
        </div>
      `;

      // filtered list
      const filtered = entries.filter(e=>{
        const matchTopic = !onlyTopic || (e.topic || 'Untitled').trim() === onlyTopic;
        const hay = (e.title + ' ' + e.text + ' ' + (e.tags||[]).join(' ')).toLowerCase();
        return matchTopic && (!q || hay.includes(q));
      });

      const cards = filtered.map(e => {
        const t = (e.topic || 'Untitled').trim() || 'Untitled';
        const tags = (e.tags||[]).map(t=>`<span class="tag">${escapeHTML(t)}</span>`).join('');
        return `
          <article class="card">
            <div class="meta">
              <strong>${escapeHTML(t)}</strong>
              <span>•</span>
              <span>${escapeHTML(e.date || '')}</span>
            </div>
            ${e.title ? `<h3>${escapeHTML(e.title)}</h3>` : ''}
            <div>${nl2br(escapeHTML(e.text))}</div>
            <div class="tags">${tags}</div>
          </article>
        `;
      }).join('') || `<div class="card" style="color:var(--muted)">No entries yet.</div>`;

      listEl.innerHTML = topicRow + cards;

      // wire up topic checkboxes
      const checks = listEl.querySelectorAll('#topicChecks input[type="checkbox"]');
      checks.forEach(ch=>{
        ch.addEventListener('change', () => {
          const t = ch.dataset.topic;
          if(ch.checked) selectedTopics.add(t); else selectedTopics.delete(t);
          countChip.textContent = `${selectedTopics.size} selected`;
        });
      });

      countChip.textContent = `${selectedTopics.size} selected`;
    }

    /********************
     * Helpers
     ********************/
    function clearForm(){
      titleEl.value = '';
      textEl.value = '';
      tagsEl.value = '';
      // keep date & topic (handy when adding several)
      titleEl.focus();
    }

    function escapeHTML(s){
      return (s || '').replace(/[&<>'"]/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'
      }[c]));
    }
    function escapeAttr(s){
      return (s || '').replace(/"/g, '&quot;');
    }
    function nl2br(s){ return s.replace(/\n/g,'<br>') }

    // Build the LLM prompt for your serverless endpoint
    function buildSummaryPrompt(grouped){
      const sections = Object.entries(grouped).map(([topic, texts])=>{
        return `### Topic: ${topic}\n${texts.map(t=>`- ${t}`).join('\n')}`;
      }).join('\n\n');

      return `You are a clinical-notes assistant. Summarize concisely with bullet points by topic. 
Keep therapeutic insights, patterns, emotions, techniques, homework, and wins. Avoid fluff. 
Return clean markdown.

${sections}`;
    }

    // simple extractive fallback: score sentences by TF and return top N per topic
    function localSummarize(grouped, maxBulletsPerTopic=6){
      const stop = new Set('a,an,the,and,or,but,if,then,so,because,of,to,in,on,for,with,as,is,are,was,were,be,been,i,me,my,we,our,you,your,they,their,it,that,this,these,those,at,by,from,about,into,not,no,very,just,too,can,could,should,would,will,may,might,over,more,less'.split(','));
      const scoreText = (text) => {
        const words = text.toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(w=>w && !stop.has(w));
        const freq = {};
        for(const w of words) freq[w] = (freq[w]||0)+1;
        const sents = text.split(/(?<=[\.\!\?])\s+/);
        const scored = sents.map(s=>{
          const ws = s.toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/);
          let score = 0;
          for(const w of ws) if(freq[w]) score += freq[w];
          return { s:s.trim(), score };
        }).filter(x=>x.s.length>0);
        scored.sort((a,b)=>b.score-a.score);
        return scored.slice(0, maxBulletsPerTopic).map(x=>x.s);
      };

      let out = [];
      for(const [topic, texts] of Object.entries(grouped)){
        const joined = texts.join(' ');
        const bullets = scoreText(joined);
        out.push(`## ${topic}`);
        for(const b of bullets) out.push(`• ${b}`);
        out.push('');
      }
      return out.join('\n');
    }
  </script>

  <!--
    🔒 About OpenAI integration

    This page will already summarize offline. If you want GPT-based summaries:

    1) Deploy to Vercel.
    2) Add a Serverless Function at /api/summarize that calls OpenAI with your key.
       Return JSON: { summary: "..." }.
    3) The button "Summarize selected topics" already POSTs to /api/summarize.
       If the API isn't there, it falls back to the offline summary above.

    This keeps your OpenAI key off the page (never put API keys in HTML/JS).
  -->
</body>
</html>
