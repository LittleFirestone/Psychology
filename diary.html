<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Healing Diary</title>

  <!-- PDF libs (client-side export) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>

  <style>
    :root{
      --bg1:#ffe0e9; --bg2:#e6f7ff; --bg3:#eaf7e4; --bg4:#fff3cd;
      --ink:#1f2937; --card:#ffffffF2; --soft:#eef2ff;
      --ring: 0 0 0 3px rgba(180,180,255,.35);
      --shadow: 0 10px 30px rgba(0,0,0,.10);
      --radius: 18px;
      --maxw: 1100px;
    }

    /* Animated pastel background */
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--ink);
      background: linear-gradient(120deg, var(--bg1), var(--bg2), var(--bg3), var(--bg4));
      background-size: 300% 300%;
      animation: pastelFlow 18s ease infinite;
    }
    @keyframes pastelFlow{
      0%{ background-position: 0% 50% }
      50%{ background-position: 100% 50% }
      100%{ background-position: 0% 50% }
    }

    .wrap{
      max-width: var(--maxw);
      margin: 40px auto 80px;
      padding: 0 20px;
    }

    .card{
      background: var(--card);
      backdrop-filter: saturate(150%) blur(12px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.55);
    }

    /* Rainbow text utilities */
    .rainbow-text{
      background: linear-gradient(90deg,#ff7aa2,#ffb86b,#ffd166,#9be15d,#64d8ff,#b39ddb);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .rainbow-chip{
      display:inline-flex; align-items:center; gap:.35rem;
      background: linear-gradient(135deg,#fff,#fff0,#fff);
      border: 1px solid rgba(0,0,0,.05);
      border-radius: 999px; padding:.35rem .75rem; font-size:.85rem; font-weight:600;
      position:relative; overflow:hidden;
    }
    .rainbow-chip::before{
      content:"";
      position:absolute; inset:-1px;
      border-radius: 999px;
      padding:1px;
      background: linear-gradient(90deg,#ff7aa2,#ffb86b,#ffd166,#9be15d,#64d8ff,#b39ddb);
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
    }

    .title{
      font-size: clamp(28px, 3.8vw, 46px);
      line-height:1.1; letter-spacing:-.02em; margin:0 0 10px;
    }
    .subtitle{
      margin:0; opacity:.8; font-weight:500;
    }

    .grid{
      display:grid; gap:20px;
      grid-template-columns: 1.2fr .8fr;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr }
    }

    .section{ padding:22px }
    .section h2{
      margin:0 0 14px; font-size:1.15rem; letter-spacing:.02em;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap }
    .input, .textarea{
      width:100%; border-radius:14px; border:1px solid #e9e9ef;
      background:#fff; padding:12px 14px; font-size:1rem; outline:none;
      box-shadow: 0 1px 0 rgba(0,0,0,.02) inset;
    }
    .input:focus, .textarea:focus{ box-shadow: var(--ring) }
    .textarea{ min-height:140px; resize:vertical }

    .btn{
      appearance:none; border:0; border-radius:14px; padding:12px 16px;
      font-weight:700; cursor:pointer; transition:.18s transform ease;
      background:#111827; color:#fff; box-shadow: 0 8px 20px rgba(17,24,39,.18);
    }
    .btn:active{ transform: translateY(1px) }
    .btn.secondary{ background:#ffffff; color:#111827; border:1px solid #e8e8ef }
    .btn.ghost{ background:transparent; color:#111827; border:1px dashed #cdd0f6 }

    .pill{
      padding:8px 12px; border-radius:12px; background:#f7f7ff; border:1px solid #eceefb;
      font-size:.9rem;
    }

    .entry{
      padding:16px; border-radius:16px; border:1px solid #eff1ff;
      background: #fff;
    }

    .divider{
      height:2px; border-radius:2px; margin:18px 0;
      background: linear-gradient(90deg,#ff7aa2,#ffb86b,#ffd166,#9be15d,#64d8ff,#b39ddb);
      opacity:.7;
    }

    .kicker{ font-size:.8rem; text-transform:uppercase; letter-spacing:.1em; opacity:.75 }
    .muted{ opacity:.7 }

    /* Print: make it clean */
    @media print{
      body{ animation:none; background:#fff }
      .btn, .controls, .no-print{ display:none !important }
      .wrap{ margin:0; max-width:900px }
      .card{ box-shadow:none; border:0; background:#fff }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="card section" style="padding:26px">
      <h1 class="title rainbow-text">Healing Diary</h1>
      <p class="subtitle">Write, tag, search, export to PDF — and get an AI newsletter-style summary.</p>
    </div>

    <div class="grid" id="page-grid">
      <!-- Left: Editor -->
      <div class="card">
        <div class="section">
          <h2 class="kicker">New entry</h2>
          <div class="row">
            <input id="topic" class="input" placeholder="Topics (comma-separated, e.g. anxiety, sleep, routine)" />
          </div>
          <div style="height:10px"></div>
          <textarea id="text" class="textarea" placeholder="Write your thoughts here…"></textarea>

          <div style="height:12px"></div>
          <div class="row">
            <button class="btn" id="saveBtn">Save entry</button>
            <button class="btn secondary" id="clearBtn">Clear</button>
            <button class="btn ghost no-print" id="pdfBtn" title="Export visible content to PDF">Export PDF</button>
          </div>
        </div>
        <div class="divider"></div>
        <div class="section">
          <h2 class="kicker">AI summary</h2>
          <div class="row">
            <input id="summary-topics" class="input" placeholder="(Optional) Focus the summary on certain topics, e.g. burnout, habits" />
          </div>
          <div style="height:10px"></div>
          <div class="row">
            <button class="btn" id="summarizeBtn">Summarize last 7 days</button>
            <span class="muted" id="summary-hint">Requires a serverless endpoint at <code>/api/summarize</code>.</span>
          </div>
          <div style="height:12px"></div>
          <div id="summaryBox" class="entry" style="display:none"></div>
        </div>
      </div>

      <!-- Right: Entries -->
      <div class="card">
        <div class="section">
          <h2 class="kicker">Your entries</h2>
          <div class="row controls">
            <input id="search" class="input" placeholder="Search…" />
            <button id="resetSearch" class="btn secondary">Reset</button>
          </div>
          <div style="height:10px"></div>
          <div id="entries"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- State & persistence ----------
    const $ = (sel) => document.querySelector(sel);
    const entriesKey = "healing_diary_entries_v3";

    function loadEntries(){
      try { return JSON.parse(localStorage.getItem(entriesKey) || "[]"); }
      catch { return []; }
    }
    function saveEntries(list){
      localStorage.setItem(entriesKey, JSON.stringify(list));
    }

    function tagChips(topicsStr){
      const topics = topicsStr.split(",").map(t=>t.trim()).filter(Boolean);
      if(!topics.length) return "";
      return topics.map(t => `<span class="rainbow-chip">${t}</span>`).join(" ");
    }

    function render(){
      const q = ($("#search").value || "").toLowerCase().trim();
      const list = loadEntries().sort((a,b)=>b.created-a.created);
      const filtered = q
        ? list.filter(e =>
            e.text.toLowerCase().includes(q) ||
            (e.topics||"").toLowerCase().includes(q)
          )
        : list;

      const html = filtered.map(e => `
        <div class="entry" style="margin-bottom:14px">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
            <div>
              <div class="rainbow-text" style="font-weight:800">${new Date(e.created).toLocaleString()}</div>
              <div class="muted" style="margin-top:4px">${tagChips(e.topics||"")}</div>
            </div>
            <div class="row">
              <button class="btn secondary" onclick="removeEntry('${e.id}')">Delete</button>
            </div>
          </div>
          <div style="height:10px"></div>
          <div style="white-space:pre-wrap">${escapeHtml(e.text)}</div>
        </div>
      `).join("");

      $("#entries").innerHTML = html || `<div class="muted">No entries yet — start by writing on the left.</div>`;
    }

    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ---------- Actions ----------
    $("#saveBtn").addEventListener("click", () => {
      const text = $("#text").value.trim();
      const topics = $("#topic").value.trim();
      if(!text){
        $("#text").focus();
        return;
      }
      const list = loadEntries();
      list.push({ id: crypto.randomUUID(), created: Date.now(), text, topics });
      saveEntries(list);
      $("#text").value = "";
      // keep topics (handy if journaling the same theme)
      render();
    });

    $("#clearBtn").addEventListener("click", () => {
      $("#text").value = "";
      $("#text").focus();
    });

    $("#search").addEventListener("input", render);
    $("#resetSearch").addEventListener("click", () => { $("#search").value=""; render(); });

    window.removeEntry = (id) => {
      const list = loadEntries().filter(e => e.id !== id);
      saveEntries(list);
      render();
    };

    // ---------- Summarize (calls your Vercel serverless function) ----------
    $("#summarizeBtn").addEventListener("click", async () => {
      const list = loadEntries().sort((a,b)=>b.created-a.created);
      const sevenDaysAgo = Date.now() - 7*24*60*60*1000;
      const recent = list.filter(e => e.created >= sevenDaysAgo);
      if(!recent.length){
        showSummary("No entries in the last 7 days to summarize.");
        return;
      }
      const focus = $("#summary-topics").value.trim();

      showSummary("Summarizing… this can take a few seconds.");
      try{
        const res = await fetch("/api/summarize",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            topics: focus,
            entries: recent.map(e => ({created:e.created, topics:e.topics||"", text:e.text}))
          })
        });

        if(!res.ok){
          const msg = await res.text();
          showSummary("Server error: " + msg);
          return;
        }
        const data = await res.json();
        showSummary(data.summary || "No summary returned.");
      }catch(err){
        showSummary("Couldn’t reach /api/summarize. Deploy the API route & set OPENAI_API_KEY on Vercel.");
      }
    });

    function showSummary(text){
      const box = $("#summaryBox");
      box.style.display = "block";
      box.innerHTML = `
        <div style="font-weight:800" class="rainbow-text">Weekly Newsletter Draft</div>
        <div style="height:8px"></div>
        <div style="white-space:pre-wrap">${escapeHtml(text)}</div>
      `;
    }

    // ---------- Export to PDF (captures main grid) ----------
    $("#pdfBtn").addEventListener("click", async () => {
      const node = document.getElementById("page-grid");
      const canvas = await html2canvas(node, { scale: 2, backgroundColor: "#ffffff" });
      const img = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit:"pt", format:"a4" });
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      const imgWidth = pageWidth - 60; // margins
      const imgHeight = canvas.height * (imgWidth/canvas.width);

      let y = 40;
      if(imgHeight <= pageHeight - 80){
        pdf.addImage(img, "PNG", 30, y, imgWidth, imgHeight, "", "FAST");
      }else{
        // split across pages
        let sHeight = imgHeight;
        let sY = 0;
        const onePageHeight = pageHeight - 80;
        while(sHeight > 0){
          pdf.addImage(img, "PNG", 30, 40 - sY, imgWidth, imgHeight, "", "FAST");
          sHeight -= onePageHeight;
          sY += onePageHeight;
          if(sHeight > 0) pdf.addPage();
        }
      }
      pdf.save(`healing-diary-${new Date().toISOString().slice(0,10)}.pdf`);
    });

    // First render
    render();
  </script>
</body>
</html>
