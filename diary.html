<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Healing Diary</title>

<!-- html2pdf for Export PDF -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-YcsIP0GLwL8aR1O45x9gN3G9b+1k2qf3m7m2G3uJrHc3m5n2m2m9nTbqk6h3l2v9Qx2d6X2pJqP1yq2pQy9e+Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<style>
  :root{
    --bg1:#fef7ff;
    --bg2:#eefbff;
    --bg3:#f9fff2;
    --card:#ffffffd9;   /* soft white, less bright */
    --text:#1f2630;
    --muted:#738195;
    --ring: rgba(255,255,255,.65);
  }

  *{ box-sizing:border-box }
  html, body{ height:100% }
  body{
    margin:0; color:var(--text); font:16px/1.45 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
    background: radial-gradient(1200px 700px at 10% 0%, var(--bg1), transparent 70%),
                radial-gradient(1000px 600px at 90% 20%, var(--bg2), transparent 70%),
                radial-gradient(900px 500px at 50% 100%, var(--bg3), transparent 70%), #f6fbff;
    min-height:100%;
    overflow-y:overlay;
  }

  /* gentle animated pastel sheen */
  body::before{
    content:""; position:fixed; inset:-30%; z-index:-1; pointer-events:none;
    background: conic-gradient(from 0deg, #ff7aa233, #ffb86b33, #ffd16633, #9be15d33, #64d8ff33, #b39ddb33, #ff7aa233);
    animation: spin 14s linear infinite;
  }
  @keyframes spin{ to{ transform: rotate(1turn) } }

  .wrap{ max-width:1100px; margin:40px auto 80px; padding:0 20px }
  header.card{ padding:22px 22px 18px; }

  h1{
    margin:0 0 6px 0; font-size:32px; font-weight:800; letter-spacing:.2px;
  }
  .rainbow-title{
    background:linear-gradient(90deg,#ff7aa2,#ffb86b,#ffd166,#9be15d,#64d8ff,#b39ddb);
    -webkit-background-clip:text; background-clip:text; color:transparent;
  }
  .subtitle{ color:var(--muted); font-size:14px }

  .grid{ display:grid; gap:24px; grid-template-columns:1.2fr .8fr; margin-top:24px }
  @media (max-width: 900px){ .grid{ grid-template-columns:1fr } }

  .card{
    position:relative; overflow:hidden;
    background:var(--card); backdrop-filter: blur(8px);
    border-radius:18px; box-shadow: 0 20px 50px rgba(53,72,91,.12);
  }
  .card-inner{ padding:18px 18px 16px }

  /* rainbow border frame */
  .rainbow-frame::before{
    content:""; position:absolute; inset:0; padding:2px; border-radius:18px;
    background:linear-gradient(90deg,#ff7aa2,#ffb86b,#ffd166,#9be15d,#64d8ff,#b39ddb);
    -webkit-mask:
      linear-gradient(#000 0 0) content-box,
      linear-gradient(#000 0 0);
    -webkit-mask-composite:xor; mask-composite:exclude;
    pointer-events:none;
    opacity:.85;
  }

  .section-title{ font-weight:700; text-transform:uppercase; font-size:13px; letter-spacing:.08em; color:#54637a; margin:0 0 10px }
  .divider, .rainbow-divider{ height:2px; border-radius:2px; margin:12px 0 }
  .divider{ background:#e8eef6 }
  .rainbow-divider{ background:linear-gradient(90deg,#ff7aa2,#ffb86b,#ffd166,#9be15d,#64d8ff,#b39ddb) }

  .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
  .row-stretch{ display:flex; gap:12px }
  .row-stretch > *{ flex:1 }

  label{ display:block; font-size:12px; letter-spacing:.06em; text-transform:uppercase; color:#536072; margin:12px 0 8px }
  input.input, textarea.input{
    width:100%; border:1px solid #e7edf6; border-radius:12px; padding:12px 14px; outline:none;
    background:#fff; color:var(--text); box-shadow: 0 1px 0 rgba(31,38,48,.03) inset;
  }
  textarea.input{ min-height:160px; resize:vertical }
  input.input:focus, textarea.input:focus{ border-color:#c9d9ee; box-shadow: 0 0 0 3px #cfe5ff66 }

  .btn{
    border:0; outline:0; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600;
    background:#f0f6ff; color:#274056; box-shadow: 0 1px 0 #fff inset, 0 8px 20px rgba(96,132,170,.18);
  }
  .btn.primary{ background:#3d8bfd; color:#fff }
  .btn.warn{ background:#ffd7d7; color:#8f1d1d }
  .btn.ghost{ background:#ffffff; }
  .btn:active{ transform: translateY(1px) }

  /* chips */
  .chip, .rainbow-chip{
    display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:600; user-select:none;
    border:1px solid #e9eef6; background:#fff;
  }
  .rainbow-chip{
    border:0;
    background:linear-gradient(#fff,#fff) padding-box, linear-gradient(90deg,#ff7aa2,#ffb86b,#ffd166,#9be15d,#64d8ff,#b39ddb) border-box;
    border:2px solid transparent; color:#2c4258;
  }

  /* entry list */
  .entry{
    position:relative; padding:14px; border-radius:14px; background:#fff; border:1px solid #e7edf6;
    box-shadow: 0 1px 0 #fff inset, 0 10px 24px rgba(53,72,91,.08);
  }
  .entry + .entry{ margin-top:12px }
  .entry time{ font-size:12px; color:#556579; font-weight:700 }
  .entry .title{ margin:6px 0 4px; font-weight:700 }
  .entry .text{ color:#47576b; white-space:pre-wrap }
  .entry .toolbar{ position:absolute; right:8px; top:8px; display:flex; gap:8px }
  .entry .toolbar .btn{ padding:6px 10px; font-size:12px }

  /* summary panel */
  .summary-box{ white-space:pre-wrap; background:#fff; border:1px solid #e7edf6; border-radius:14px; padding:14px; min-height:80px }

  .muted{ color:var(--muted) }
  .small{ font-size:12px }
</style>
</head>
<body>
  <div class="wrap">
    <!-- HEADER -->
    <header class="card rainbow-frame">
      <div class="card-inner">
        <h1 class="rainbow-title">Healing Diary</h1>
        <div class="subtitle">Write, tag, search, export to PDF â€” and get an AI newsletter-style summary.</div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: NEW ENTRY & SUMMARY -->
      <section class="card rainbow-frame">
        <div class="card-inner">
          <div class="section-title">New Entry</div>

          <label>Title</label>
          <input id="title" class="input" placeholder="Give this a punchy title" />

          <label>Topics (comma-separated)</label>
          <input id="topic" class="input" placeholder="e.g. burnout, exercise, therapy, habits" />
          <div id="tagPreview" class="row" style="margin-top:6px"></div>

          <label>Notes</label>
          <textarea id="text" class="input" placeholder="Write your thoughts hereâ€¦"></textarea>

          <div class="row" style="margin-top:12px">
            <button class="btn primary" onclick="addEntry()">Save entry</button>
            <button class="btn" onclick="clearForm()">Clear</button>
            <button class="btn ghost" onclick="exportPdf()">Export PDF</button>
          </div>

          <div class="rainbow-divider"></div>

          <div class="section-title">AI Summary</div>
          <div class="small muted" style="margin-bottom:8px">Optionally focus the summary on certain topics</div>
          <input id="focusTopics" class="input" placeholder="(Optional) Focus the summary on: burnout, sleep, winsâ€¦" />
          <div class="row" style="margin-top:10px">
            <button class="btn" onclick="summarizeLast7()">Summarize last 7 days</button>
            <span class="small muted">Requires the serverless endpoint at <code>/api/summarize</code>.</span>
          </div>
          <div id="summary" class="summary-box" style="margin-top:12px">Weekly Newsletter Draft will appear hereâ€¦</div>
        </div>
      </section>

      <!-- RIGHT: ENTRIES LIST -->
      <aside class="card rainbow-frame">
        <div class="card-inner">
          <div class="section-title">Your Entries</div>
          <div class="row-stretch">
            <input id="search" class="input" placeholder="Searchâ€¦" oninput="renderEntries()" />
            <button class="btn" onclick="resetSearch()">Reset</button>
          </div>

          <div id="entries" style="margin-top:14px"></div>
        </div>
      </aside>
    </div>
  </div>

<script>
/* ----------------- Local storage helpers ----------------- */
const LS_KEY = "healing_diary_entries_v2";

function loadEntries(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)) || [] }
  catch{ return [] }
}
function saveEntries(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)) }

/* ----------------- Tags preview while typing ----------------- */
function splitTopics(s){
  return s.split(",").map(t => t.trim()).filter(Boolean);
}
function tagChips(topicsStr){
  const topics = splitTopics(topicsStr);
  if(!topics.length) return "";
  return topics.map(t => `<span class="rainbow-chip">${t}</span>`).join(" ");
}
const topicEl = document.getElementById("topic");
topicEl.addEventListener("input", () => {
  document.getElementById("tagPreview").innerHTML = tagChips(topicEl.value);
});

/* ----------------- CRUD ----------------- */
function clearForm(){
  document.getElementById("title").value = "";
  document.getElementById("topic").value = "";
  document.getElementById("text").value  = "";
  document.getElementById("tagPreview").innerHTML = "";
}

function addEntry(){
  const title = document.getElementById("title").value.trim();
  const topics = document.getElementById("topic").value.trim();
  const text  = document.getElementById("text").value.trim();
  if(!text && !title){ alert("Write something first ðŸ˜Š"); return }

  const entries = loadEntries();
  entries.unshift({
    id: crypto.randomUUID(),
    created: Date.now(),
    title, topics, text
  });
  saveEntries(entries);
  clearForm();
  renderEntries();
}

function deleteEntry(id){
  const entries = loadEntries().filter(e => e.id !== id);
  saveEntries(entries);
  renderEntries();
}

/* ----------------- Render ----------------- */
function formatDate(ts){
  const d = new Date(ts);
  return d.toLocaleDateString(undefined,{year:'numeric',month:'2-digit',day:'2-digit'}) +
         " " +
         d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
}

function snippet(s, n=180){ s = s || ""; return s.length>n ? s.slice(0,n)+"â€¦" : s }

function renderEntries(){
  const q = (document.getElementById("search").value || "").toLowerCase();
  const wrap = document.getElementById("entries");
  const entries = loadEntries().filter(e=>{
    const hay = (e.title+" "+e.topics+" "+e.text).toLowerCase();
    return hay.includes(q);
  });

  if(!entries.length){
    wrap.innerHTML = `<div class="muted small">No entries yet.</div>`;
    return;
  }

  wrap.innerHTML = entries.map(e => `
    <div class="entry">
      <div class="toolbar">
        <button class="btn warn" onclick="deleteEntry('${e.id}')">Delete</button>
      </div>
      <time>${formatDate(e.created)}</time>
      ${e.topics ? `<div style="margin:6px 0">${tagChips(e.topics)}</div>` : ""}
      ${e.title ? `<div class="title">${e.title}</div>` : ""}
      <div class="text">${snippet(e.text)}</div>
    </div>
  `).join("");
}

function resetSearch(){
  document.getElementById("search").value = "";
  renderEntries();
}

/* ----------------- Export PDF ----------------- */
function exportPdf(){
  const node = document.querySelector(".wrap");
  const opt = {
    margin:       10,
    filename:     `HealingDiary_${new Date().toISOString().slice(0,10)}.pdf`,
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2, useCORS:true },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().set(opt).from(node).save();
}

/* ----------------- AI Summary ----------------- */
async function summarizeLast7(){
  const all = loadEntries();
  const weekAgo = Date.now() - 7*24*60*60*1000;
  const recent = all.filter(e => e.created >= weekAgo);
  const topics = document.getElementById("focusTopics").value;

  const out = document.getElementById("summary");
  out.textContent = "Summarizingâ€¦";

  try{
    const r = await fetch("/api/summarize",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ entries: recent, topics })
    });
    if(!r.ok){
      const text = await r.text();
      throw new Error(text || `HTTP ${r.status}`);
    }
    const data = await r.json();
    out.textContent = data.summary || "(No summary returned)";
  }catch(err){
    out.innerHTML = `Server error: ${err.message}\n\nTip: Ensure your Vercel project has an <b>OPENAI_API_KEY</b> and that <code>api/summarize.js</code> exists.`;
  }
}

/* ----------------- Init ----------------- */
renderEntries();
</script>
</body>
</html>
